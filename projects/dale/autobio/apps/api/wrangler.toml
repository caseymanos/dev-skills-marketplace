# Autobiography Builder API Worker
name = "autobiography-api"
main = "src/index.ts"
compatibility_date = "2024-12-01"
compatibility_flags = ["nodejs_compat"]

# Development settings
[dev]
port = 8787

# Environment variables (secrets should be added via wrangler secret)
[vars]
ENVIRONMENT = "development"

# D1 Database
[[d1_databases]]
binding = "DB"
database_name = "autobiography-db"
database_id = "1e9b2d62-e6c4-4335-ac4c-991076d17000"
migrations_dir = "../../infrastructure/migrations"

# R2 Storage Bucket
[[r2_buckets]]
binding = "STORAGE"
bucket_name = "autobiography-files"

# KV Namespace for caching
[[kv_namespaces]]
binding = "CACHE"
id = "6b03fb45f5e24b55916737bd29520f76"

# Queue Producers
[[queues.producers]]
binding = "PARSE_QUEUE"
queue = "autobiography-parse"

[[queues.producers]]
binding = "ANALYZE_QUEUE"
queue = "autobiography-analyze"

[[queues.producers]]
binding = "WRITE_QUEUE"
queue = "autobiography-write"

[[queues.producers]]
binding = "BUILD_QUEUE"
queue = "autobiography-build"

# Durable Objects
[durable_objects]
bindings = [
  { name = "PROGRESS_TRACKER", class_name = "ProgressTracker" }
]

[[migrations]]
tag = "v1"
new_classes = ["ProgressTracker"]

# Production environment overrides
[env.production]
name = "autobiography-api-prod"
[env.production.vars]
ENVIRONMENT = "production"
